import{r as n,j as s,F as _,a as b}from"./jsx-runtime-f40812bf.js";import{b as P,E as he,aD as pe,f as o,u as ee,S as I,v as V,aE as te,d as u,aF as ve,c as z,C as x,aG as be,aH as Se,aI as ye,L as ae,aJ as Ce,W as we,a0 as Pe,aK as Ie,h as Ae}from"./Phone-fde4bf37.js";import{r as re}from"./number-28525126.js";function Fe(){const f=P(Ae),{Placement:ne}=n.useContext(he),se=P(x.CameraComponent),E=P(I.Unlocked),j=P(I.PassedFaceId),O=P(I.Visible),oe=P(I.LockScreenVisible),[ke,A]=ne.PhoneRotation,[$,S]=n.useState(!1),[c,M]=n.useState("Photo"),[F,H]=n.useState(!1),[ie,G]=n.useState(!1),[ce,L]=n.useState(!1),[k,W]=n.useState(!1),[d,le]=n.useState(!1),[X,K]=n.useState(0),[de,B]=n.useState({}),D=n.useRef(null),U=n.useRef(null),y=n.useRef(null),l=n.useRef(null),g=n.useRef(null),m=["Video","Photo","Landscape"];n.useEffect(()=>{if(!y.current||l.current)return;let e=new pe(y.current);l.current=e},[y.current,O]),n.useEffect(()=>{var e;return(e=navigator.mediaDevices)==null||e.getUserMedia({audio:!0}).then(t=>{g.current=t}),()=>{l.current&&l.current.destroy(),g.current&&g.current.getTracks().forEach(t=>t.stop()),se||o("Camera",{action:"close"})}},[]),ee("camera:usedCommand",e=>{switch(e){case"toggleTaking":R();break;case"toggleFlip":W(t=>!t);break;case"toggleFlash":H(t=>!t);break;case"leftMode":if(d)return;M(t=>{const a=m.indexOf(t);return a===0?m[m.length-1]:m[a-1]});break;case"rightMode":if(d)return;M(t=>{const a=m.indexOf(t);return a===m.length-1?m[0]:m[a+1]});break}}),n.useEffect(()=>{if(!U.current)return;let e=[];const a=setInterval(()=>{e.length>2&&(e=[]),e.push("."),U.current.innerText=ae("APPS.CAMERA.UPLOADING")+e.join("")},500);return()=>clearInterval(a)},[$]);const T=(e,t)=>{if(t===void 0&&(t=we(e)),t){const a=document.createElement("video");a.src=e,a.muted=!0,a.play();const r=document.createElement("canvas");if(!r)return;a.addEventListener("loadeddata",()=>{r.width=a.videoWidth,r.height=a.videoHeight,r.getContext("2d").drawImage(a,0,0,r.width,r.height);const p=r.toDataURL("image/png");D.current.style.backgroundImage=`url(${p})`,V.APPS.CAMERA.lastImage.set(p),r.remove(),a.remove()})}else D.current.style.backgroundImage=`url(${e})`,V.APPS.CAMERA.lastImage.set(e)};n.useEffect(()=>{if(o("Camera",{action:O?"open":"close"}),oe||!E)I.Flashlight&&(o("toggleFlashlight",{toggled:!1}),I.Flashlight.set(!1)),A(0),M("Photo");else{if(o("Camera",{action:"flipCamera",value:k}),V.APPS.CAMERA.lastImage.value)return T(V.APPS.CAMERA.lastImage.value);o("Camera",{action:"getLastImage"}).then(e=>{e&&T(e)})}},[E,j,O]),n.useEffect(()=>{if(d)return;switch(c){case"Landscape":B({marginRight:"9rem"}),A(90);break;case"Video":A(0),B({marginLeft:"12rem"});break;default:A(0),B({marginLeft:"3rem"});break}c==="Landscape"?l.current&&l.current.resizeByAspect(16/9):(c==="Video"||c==="Photo")&&l.current&&l.current.resizeByAspect(3/4),o("Camera",{action:"toggleLandscape",toggled:c==="Landscape"}),o("Camera",{action:"toggleVideo",toggled:c==="Video"});const e=window.innerWidth;e>1920&&l.current.setQuality(1920/e),c==="Photo"&&k?l.current.setXOffset(-.2):l.current.setXOffset(0)},[c]),n.useEffect(()=>{o("Camera",{action:"flipCamera",value:k}),!d&&(c=="Photo"&&k?l.current.setXOffset(-.2):l.current.setXOffset(0))},[E,k]);const J=n.useRef(!0),Q=async(e,t)=>{const a=re(e.size/1e3,2);F&&o("toggleFlashlight",{toggled:!1});try{const r=await Pe(t?"Video":"Image",e);return t?T(URL.createObjectURL(e),!0):T(r),u("info",`Saved ${t?"video":"photo"} to gallery (${a}kb) - ${r}`),await Ie(r,a),!0}catch(r){throw r}};ee("camera:toggleMicrophone",e=>{g.current&&(g.current.getAudioTracks()[0].enabled=e)}),n.useEffect(()=>{if(J.current){J.current=!1;return}if(F&&!d&&o("toggleFlashlight",{toggled:!1}),!d)return;const e=y.current.captureStream(f.videoOptions.fps),t=new AudioContext,a=new MediaStreamAudioDestinationNode(t);g.current?(o("isTalking").then(C=>{g.current.getAudioTracks()[0].enabled=C}),t.createMediaStreamSource(g.current).connect(a)):t.createOscillator().connect(a);let r;if(f.recordNearbyVoices){r=f.ice?new te({config:{iceTransportPolicy:"relay",iceServers:f.ice}}):new te,r.on("open",h=>{o("Camera",{action:"setRecordingPeerId",peerId:h}),u("info","Listening for nearby voices")});const i=document.createElement("canvas");i.width=1,i.height=1;const C=i.captureStream(0);r.on("call",h=>{h.answer(C),h.on("stream",w=>{u("info","Received nearby voice");const N=new Audio;N.srcObject=w,N.volume=0,N.play(),new MediaStreamAudioSourceNode(t,{mediaStream:w}).connect(a)}),h.on("close",()=>{u("info","Stopped receiving nearby voice")})})}const p=[e.getVideoTracks()[0]];(g.current||f.recordNearbyVoices)&&p.unshift(a.stream.getAudioTracks()[0]);const fe=new MediaStream(p),v=new MediaRecorder(fe,{mimeType:"video/webm;codecs=vp9,opus",videoBitsPerSecond:f.videoOptions.bitrate*8*1e3});let q=Date.now();const ge=v.audioBitsPerSecond+v.videoBitsPerSecond,Y=setInterval(()=>{const i=(Date.now()-q)/1e3,h=ge*i/8/1024/1024,w=re(h,2);w>=f.videoOptions.size&&(u("info",`Video file size limit reached (${w}mb)`),clearInterval(Y),R())},100);let Z=[];v.ondataavailable=i=>{Z.push(i.data)},v.onerror=i=>{u("error","error recording:",i)},v.onstop=async()=>{clearInterval(Y);let i=Date.now()-q,C=new Blob(Z,{type:"video/webm"});const h=await ve(C,i,{logger:!1});S(!0),t.close(),r&&(r.destroy(),u("info","Destroyed peer connection"),o("Camera",{action:"endedRecording"}));try{await Q(h,!0),S(!1)}catch{S(!1),L(!0),await new Promise(N=>setTimeout(N,1e4)),L(!1)}},v.start();const me=setInterval(()=>{if(X>=f.videoOptions.duration)return R();K(i=>i+1>=f.videoOptions.duration?(R(),0):i+1)},1e3);return()=>{K(0),clearInterval(me),v.stop()}},[d]);const ue=e=>{let t=(e%60).toString(),a=(Math.floor(e/60)%60).toString(),r=Math.floor(e/3600).toString();return parseInt(r)<10&&(r="0"+r),parseInt(a)<10&&(a="0"+a),parseInt(t)<10&&(t="0"+t),r+":"+a+":"+t},R=async()=>{var t,a;if($)return u("info","Returning since an image is currently uploading");if(F&&await o("toggleFlashlight",{toggled:!0}),c=="Video"){await o("Camera",{action:"toggleHud",toggled:d}),le(r=>!r);return}await o("Camera",{action:"toggleHud",toggled:!1}),(a=(t=z.Settings.value)==null?void 0:t.sound)!=null&&a.silent||z.SoundManager.set({url:"./assets/sound/other/cameraShutter.mp3"}),G(!0),x.IndicatorVisible.set(!1),S(!0),u("info","Uploading image, converting to blob");const e=await new Promise(r=>y.current.toBlob(r));try{await Q(e,!1),u("info","Image uploaded successfully"),S(!1),x.IndicatorVisible.set(!0)}catch{S(!1),L(!0),x.IndicatorVisible.set(!0),await new Promise(p=>setTimeout(p,1e4)),L(!1)}G(!1),await o("Camera",{action:"toggleHud",toggled:!0})};return s(_,{children:b("div",{className:"camera-container",children:[b("div",{className:"camera-header",children:[s("div",{className:"flash",onClick:()=>H(e=>!e),children:!d&&F?s(be,{}):s(Se,{})}),c==="Video"&&b(_,{children:[s("div",{className:"timer",children:ue(X)}),s("span",{})]})]}),b("div",{className:`camera-body ${c=="Landscape"?"rotate":""}`,children:[s("canvas",{ref:y,style:{visibility:ie?"hidden":"visible"}}),$&&b("div",{className:"loading",children:[s(ye,{size:80,speed:1,color:"#ffffff"}),s("div",{className:"uploading",ref:U,children:"Uploading..."})]}),ce&&s("div",{className:"loading",children:s("div",{className:"uploading",children:"Failed to upload, tell the server owner to check their API keys in lb-phone/server/apiKeys.lua"})})]}),b("div",{className:"camera-bottom",children:[s("div",{className:"camera-types",style:de,children:m.map((e,t)=>s("div",{className:`${c===e&&"active"}`,onClick:()=>M(e),children:ae(`APPS.CAMERA.${e.toUpperCase()}`)},t))}),b("div",{className:"camera-buttons",children:[s("div",{className:"image-gallery",ref:D,onClick:()=>{!j&&!E||(o("Camera",{action:"close"}),A(0),z.App.set({name:"Photos"}))}}),s("div",{className:"camera-button",onClick:()=>R(),children:s("div",{className:"camera-button-container",children:s("div",{className:`camera-button-inner ${c=="Video"&&`${c} ${d==!0&&"Recording"}`}`})})}),s("div",{className:"flip-camera",onClick:()=>{W(e=>!e)},children:s(Ce,{})})]})]})]})})}export{Fe as default};
