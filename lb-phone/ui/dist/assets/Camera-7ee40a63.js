import{r,j as n,F as J,a as h}from"./jsx-runtime-f40812bf.js";import{s as fe,V as me,w as ge,x as he,f as c,u as pe,S as C,o as O,W as ve,d as b,X as Se,Y as Ce,b as D,C as F,Z as be,L as _,z as Pe,A as we,Q as ye,h as Ie}from"./Phone-a6f774c9.js";import{u as P,O as Ae,P as Re,Q as ke}from"./index.esm-497ba86e.js";import{r as ee}from"./number-28525126.js";function Le(){const f=P(Ie),{Placement:te}=r.useContext(fe),ae=P(F.CameraComponent),R=P(C.Unlocked),j=P(C.PassedFaceId),L=P(C.Visible),se=P(C.LockScreenVisible),[Ne,w]=te.PhoneRotation,[V,p]=r.useState(!1),[o,k]=r.useState("Photo"),[N,H]=r.useState(!1),[re,X]=r.useState(!1),[ne,M]=r.useState(!1),[m,W]=r.useState(!1),[d,oe]=r.useState(!1),[G,Q]=r.useState(0),[ie,x]=r.useState({}),$=r.useRef(null),T=r.useRef(null),v=r.useRef(null),l=r.useRef(null),y=r.useRef(null),u=["Video","Photo","Landscape"];r.useEffect(()=>{if(!v.current||l.current)return;let e=new me(v.current);l.current=e},[v.current,L]),r.useEffect(()=>(ge("Camera").then(e=>{e&&(y.current=e)}),()=>{l.current&&l.current.destroy(),y.current&&he("Camera"),ae||c("Camera",{action:"close"})}),[]),pe("camera:usedCommand",e=>{switch(e){case"toggleTaking":I();break;case"toggleFlip":W(t=>!t);break;case"toggleFlash":H(t=>!t);break;case"leftMode":if(d)return;k(t=>{const a=u.indexOf(t);return a===0?u[u.length-1]:u[a-1]});break;case"rightMode":if(d)return;k(t=>{const a=u.indexOf(t);return a===u.length-1?u[0]:u[a+1]});break}}),r.useEffect(()=>{if(!T.current)return;let e=[];const a=setInterval(()=>{e.length>2&&(e=[]),e.push("."),T.current.innerText=_("APPS.CAMERA.UPLOADING")+e.join("")},500);return()=>clearInterval(a)},[V]);const E=(e,t)=>{if(t===void 0&&(t=Pe(e)),t){const a=document.createElement("video");a.src=e,a.muted=!0,a.play();const s=document.createElement("canvas");if(!s)return;a.addEventListener("loadeddata",()=>{s.width=a.videoWidth,s.height=a.videoHeight,s.getContext("2d").drawImage(a,0,0,s.width,s.height);const S=s.toDataURL("image/png");$.current.style.backgroundImage=`url(${S})`,O.APPS.CAMERA.lastImage.set(S),s.remove(),a.remove()})}else $.current.style.backgroundImage=`url(${e})`,O.APPS.CAMERA.lastImage.set(e)};r.useEffect(()=>{if(c("Camera",{action:L?"open":"close"}),se||!R)C.Flashlight&&(c("toggleFlashlight",{toggled:!1}),C.Flashlight.set(!1)),w(0),k("Photo");else{if(c("Camera",{action:"flipCamera",value:m}),O.APPS.CAMERA.lastImage.value)return E(O.APPS.CAMERA.lastImage.value);c("Camera",{action:"getLastImage"}).then(e=>{e&&E(e)})}},[R,j,L]),r.useEffect(()=>{if(d)return;switch(o){case"Landscape":x({marginRight:"9rem"}),w(90);break;case"Video":w(0),x({marginLeft:"12rem"});break;default:w(0),x({marginLeft:"3rem"});break}o==="Landscape"?l.current&&l.current.resizeByAspect(16/9):(o==="Video"||o==="Photo")&&l.current&&l.current.resizeByAspect(3/4),c("Camera",{action:"toggleLandscape",toggled:o==="Landscape"}),c("Camera",{action:"toggleVideo",toggled:o==="Video"});const e=window.innerWidth;e>1920&&l.current.setQuality(1920/e),o==="Photo"&&m?l.current.setXOffset(-.2):l.current.setXOffset(0)},[o]),r.useEffect(()=>{c("Camera",{action:"flipCamera",value:m}),!d&&(o=="Photo"&&m?l.current.setXOffset(-.2):l.current.setXOffset(0))},[R,m]);const q=r.useRef(!0),K=async(e,t)=>{const a=ee(e.size/1e3,2);N&&c("toggleFlashlight",{toggled:!1});try{const s=await we(t?"Video":"Image",e);return t?E(URL.createObjectURL(e),!0):E(s),b("info",`Saving ${t?"video":"photo"} to gallery (${a}kb) - ${s}, args(${s}, ${a}, ${m&&!t?"selfie":null})`),await ye(s,a,m&&!t?"selfie":null,!0),!0}catch(s){throw s}};r.useEffect(()=>{if(q.current){q.current=!1;return}if(N&&!d&&c("toggleFlashlight",{toggled:!1}),!d)return;const e=v.current.captureStream(f.videoOptions.fps),t=new AudioContext,a=new MediaStreamAudioDestinationNode(t);y.current?t.createMediaStreamSource(y.current).connect(a):t.createOscillator().connect(a),ve("Camera",t,a);const s=[e.getVideoTracks()[0]];(y.current||f.recordNearbyVoices)&&s.unshift(a.stream.getAudioTracks()[0]);const S=new MediaStream(s),g=new MediaRecorder(S,{mimeType:"video/webm;codecs=vp9,opus",videoBitsPerSecond:f.videoOptions.bitrate*8*1e3});let z=0;const le=g.audioBitsPerSecond+g.videoBitsPerSecond,Y=setInterval(()=>{const i=(Date.now()-z)/1e3,B=le*i/8/1024/1024,U=ee(B,2);U>=f.videoOptions.size&&(b("info",`Video file size limit reached (${U}mb)`),clearInterval(Y),I())},100);let Z=[];g.ondataavailable=i=>{var A;((A=i==null?void 0:i.data)==null?void 0:A.size)>0&&Z.push(i.data)},g.onerror=i=>{b("error","error recording:",i)},g.onstop=async()=>{clearInterval(Y);let i=Date.now()-z,A=new Blob(Z,{type:"video/webm"});t.close(),p(!0),Se("Camera");const B=await Ce(A,i,{logger:!1});try{await K(B,!0),p(!1)}catch{p(!1),M(!0),await new Promise(ue=>setTimeout(ue,1e4)),M(!1)}},z=Date.now(),g.start();const de=setInterval(()=>{if(G>=f.videoOptions.duration)return I();Q(i=>i+1>=f.videoOptions.duration?(I(),0):i+1)},1e3);return()=>{Q(0),clearInterval(de),g.stop()}},[d]);const ce=e=>{let t=(e%60).toString().padStart(2,"0"),a=(Math.floor(e/60)%60).toString().padStart(2,"0");return Math.floor(e/3600).toString().padStart(2,"0")+":"+a+":"+t},I=async()=>{var t,a;if(V)return b("info","Returning since an image is currently uploading");if(N&&await c("toggleFlashlight",{toggled:!0}),o=="Video"){await c("Camera",{action:"toggleHud",toggled:d}),oe(s=>!s);return}await c("Camera",{action:"toggleHud",toggled:!1}),(a=(t=D.Settings.value)==null?void 0:t.sound)!=null&&a.silent||D.SoundManager.set({url:"./assets/sound/other/cameraShutter.mp3"}),X(!0),F.IndicatorVisible.set(!1),p(!0),b("info","Uploading image, converting to blob");const e=await new Promise(s=>v.current.toBlob(s,f.imageOptions.mime,f.imageOptions.quality));try{await K(e,!1),b("info","Image uploaded successfully"),p(!1),F.IndicatorVisible.set(!0)}catch{p(!1),M(!0),F.IndicatorVisible.set(!0),await new Promise(S=>setTimeout(S,1e4)),M(!1)}X(!1),await c("Camera",{action:"toggleHud",toggled:!0})};return n(J,{children:h("div",{className:"camera-container",children:[h("div",{className:"camera-header",children:[n("div",{className:"flash",onClick:()=>H(e=>!e),children:!d&&N?n(Ae,{}):n(Re,{})}),o==="Video"&&h(J,{children:[n("div",{className:"timer",children:ce(G)}),n("span",{})]})]}),h("div",{className:`camera-body ${o=="Landscape"?"rotate":""}`,children:[n("canvas",{ref:v,style:{visibility:re?"hidden":"visible"}}),V&&h("div",{className:"loading",children:[n(be,{size:80,speed:1,color:"#ffffff"}),n("div",{className:"uploading",ref:T,children:"Uploading..."})]}),ne&&n("div",{className:"loading",children:n("div",{className:"uploading",children:"Failed to upload, tell the server owner to check their API keys in lb-phone/server/apiKeys.lua"})})]}),h("div",{className:"camera-bottom",children:[n("div",{className:"camera-types",style:ie,children:u.map((e,t)=>n("div",{className:`${o===e&&"active"}`,onClick:()=>k(e),children:_(`APPS.CAMERA.${e.toUpperCase()}`)},t))}),h("div",{className:"camera-buttons",children:[n("div",{className:"image-gallery",ref:$,onClick:()=>{!j&&!R||(c("Camera",{action:"close"}),w(0),D.App.set({name:"Photos"}))}}),n("div",{className:"camera-button",onClick:()=>I(),children:n("div",{className:"camera-button-container",children:n("div",{className:`camera-button-inner ${o=="Video"&&`${o} ${d==!0&&"Recording"}`}`})})}),n("div",{className:"flip-camera",onClick:()=>{W(e=>!e)},children:n(ke,{})})]})]})]})})}export{Le as default};
