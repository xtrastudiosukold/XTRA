var Ie=Object.defineProperty;var ye=(t,n,h)=>n in t?Ie(t,n,{enumerable:!0,configurable:!0,writable:!0,value:h}):t[n]=h;var z=(t,n,h)=>(ye(t,typeof n!="symbol"?n+"":n,h),h);import{r as d,j as e,F as se,a as m}from"./jsx-runtime-f40812bf.js";import{f as L,b as _,u as K,K as De,M as oe,I as Le,L as l,n as V,N as ke,p as Re,O as Me,Q as ce,k as te,R as pe,C as Y,h as J,T as _e,U as be,V as Ee,d as W,v as q,W as $e,X as ge,Y as Ve,c as x,Z as Ye,_ as Pe,a0 as Fe,a1 as je,a2 as ne,a3 as re,i as He,t as xe,a4 as Xe,y as qe,z as Be,a5 as Qe,x as Ce,m as Q,a6 as We,a7 as ze,a8 as Ke}from"./Phone-eb89da6c.js";import{r as Ne,f as ve}from"./number-28525126.js";const Ae=(t,n=25,h=7,A=360,i=120)=>new Promise((a,r)=>{let c=document.createElement("canvas");c.width=A,c.height=i;let u=c.getContext("2d");u.fillStyle="#000";let M=new AudioContext;t.arrayBuffer().then(o=>M.decodeAudioData(o)).then(o=>{let p=(c.width-(n-1)*h)/n,I=c.height/2,k=Math.floor(o.length/n),E=o.getChannelData(0);for(let T=0;T<n;T++){let G=1,y=.1;for(let O=0;O<k;O++){let b=E[T*k+O];b<G&&(G=b),b>y&&(y=b)}let D=(1+G)*I,R=(y-G)*I;u.beginPath(),u.moveTo(T*(p+h),D),u.lineTo(T*(p+h),D+R),u.lineTo(T*(p+h)+p,D+R),u.lineTo(T*(p+h)+p,D),u.closePath(),u.fill()}c.toBlob(T=>a({blob:T,base64:c.toDataURL()}))})});class Je{constructor(){z(this,"recorder");z(this,"chunks");z(this,"stream");z(this,"mute",()=>{this.recorder&&this.recorder.stream.getTracks().forEach(n=>n.enabled=!1)});z(this,"unmute",()=>{this.recorder&&this.recorder.stream.getTracks().forEach(n=>n.enabled=!0)});this.recorder=null,this.chunks=[]}start(n){this.stream=n,this.recorder=new MediaRecorder(n),this.recorder.ondataavailable=h=>this.chunks.push(h.data),this.chunks=[],this.recorder.start(),L("isTalking").then(h=>{h?this.unmute():this.mute()})}stop(){const{recorder:n,chunks:h}=this;return new Promise(A=>{n.onstop=()=>{const i=new Blob(h,{type:n.mimeType}),a=new Audio;a.src=URL.createObjectURL(i),this.stream&&this.stream.getTracks().forEach(c=>c.stop());let r={blob:i};Ae(i).then(c=>{Ae(i,60,7,960,200).then(u=>{r.waveform={message:c.blob,placeholder:u.base64},a.duration===1/0?(a.currentTime=Number.MAX_SAFE_INTEGER,a.ontimeupdate=()=>A({...r,duration:Math.floor(a.duration+.5)})):A({...r,duration:Math.floor(a.duration+.5)})})})},n.stop()})}}function Ze(){const{User:t,View:n,UnreadMessages:h}=d.useContext(Z),A=_(x.Settings),i=_(x.PhoneNumber),[a,r]=t,[c,u]=n,[M,o]=h,p=_(Y.Emoji),[I,k]=d.useState(!1),[E,T]=d.useState(null),[G,y]=d.useState(!1),[D,R]=d.useState(!1),[O,b]=d.useState(0),[H,X]=d.useState(0),[g,S]=d.useState(!1),[v,w]=d.useState(!1),[P,N]=d.useState([]),[F,ae]=d.useState(null),ie=d.useRef(null),me=d.useRef(0),[$,ee]=d.useState({content:"",attachments:[]}),j=_(J);d.useEffect(()=>{L("Messages",{action:"getMessages",page:0,id:a.id}).then(s=>{s&&s.length>0?N([...s.reverse()]):S(!0)})},[]);const le=d.useRef(!1),de=()=>{if($.content.length>0||$.attachments.length>0||F){let s={sender:i,timestamp:Date.now(),id:a.id,content:$.content,attachments:$.attachments};if(A.airplaneMode)return N(f=>[...f,{...s,delivered:!1}]);if(F){if(le.current)return;le.current=!0,Ee("Image",F.waves.message).then(f=>{Ee("Audio",F.blob).then(C=>{s.content=`<!AUDIO-MESSAGE-IMAGE="${f}"-AUDIO="${C}"-DURATION="${F.duration}"!>`,L("Messages",{action:"sendMessage",number:a.number,content:s.content,id:a.id}).then(U=>{N(U?B=>[...B,s]:B=>[...B,{...s,delivered:!1}]),le.current=!1,ae(null)})})});return}if(F)return;L("Messages",{action:"sendMessage",number:a.number,content:$.content,attachments:$.attachments,id:a.id}).then(f=>{f?(N(C=>[...C,s]),ae(null)):N(C=>[...C,{...s,delivered:!1}]),ee({content:"",attachments:[]}),ie.current&&(ie.current.value=""),W("info","Updating recent message cache state"),q.APPS.MESSAGES.messages.set(q.APPS.MESSAGES.messages.value.map(C=>C.id===a.id?{...C,timestamp:new Date().getTime(),lastMessage:s.content}:C))})}},ue=s=>{if(j.EnableMessagePay&&!(!s&&s<=0)){if(s>((j==null?void 0:j.MaxTransferAmount)??Number.MAX_SAFE_INTEGER))return W("error","Amount is too high");Y.PopUp.set({title:l("APPS.MESSAGES.PAY.SEND_TITLE").format({amount:j.CurrencyFormat.replace("%s",s.toString())}),description:l("APPS.MESSAGES.PAY.SEND_DESCRIPTION").format({amount:j.CurrencyFormat.replace("%s",s.toString()),name:a.name??V(a.number)}),buttons:[{title:l("APPS.MESSAGES.PAY.SEND_BUTTON_CANCEL")},{title:l("APPS.MESSAGES.PAY.SEND_BUTTON_SEND"),cb:()=>{L("Wallet",{action:"sendPayment",number:a.number,amount:s}).then(f=>{if(!f.success){W("error","Failed to send payment "+JSON.stringify(f)),setTimeout(()=>{Y.PopUp.set({title:l("APPS.MESSAGES.PAYMENT_FAILED_POPUP.TITLE"),description:l("APPS.MESSAGES.PAYMENT_FAILED_POPUP.DESCRIPTION").format({error:f.reason}),buttons:[{title:l("APPS.MESSAGES.PAYMENT_FAILED_POPUP.CLOSE")}]})},500);return}let C={id:a.id,sender:i,content:`<!SENT-PAYMENT-${s}!>`,attachments:[],timestamp:Date.now()};N(U=>[...U,C])})}}]})}},Te=s=>{if(!j.EnableMessagePay||!s&&s<=0)return;let f={sender:i,content:`<!REQUESTED-PAYMENT-${s}!>`,attachments:[],timestamp:Date.now()};L("Messages",{action:"sendMessage",number:a.number,content:f.content,attachments:[]}).then(C=>{N(C?U=>[...U,f]:U=>[...U,{...f,delivered:!1}])})},he=()=>{Y.PopUp.set({title:l("APPS.MESSAGES.SEND_LOCATION_POPUP.TITLE"),description:l("APPS.MESSAGES.SEND_LOCATION_POPUP.TEXT"),buttons:[{title:l("APPS.MESSAGES.SEND_LOCATION_POPUP.CANCEL")},{title:l("APPS.MESSAGES.SEND_LOCATION_POPUP.SEND"),cb:()=>{L("Maps",{action:"getCurrentLocation"}).then(s=>{if(!s)return;let f={id:a.id,sender:i,content:`<!SENT-LOCATION-X=${Ne(s.x,2)}Y=${Ne(s.y,2)}!>`,attachments:[],timestamp:Date.now()};L("Messages",{action:"sendMessage",number:a.number,content:f.content,attachments:f.attachments,id:f.id}).then(C=>{N(C?U=>[...U,f]:U=>[...U,{...f,delivered:!1}])})})}}]})},we=()=>{if(g||v)return;let s=document.querySelector("#last");if(!s)return;!$e(s)&&(w(!0),L("Messages",{action:"getMessages",page:H+1,id:a.id}).then(C=>{if(C&&C.length>0){let U=document.querySelector(".message-container");me.current=U.scrollHeight,N([...C.reverse(),...P]),w(!1)}else S(!0)}),X(C=>C+1))};d.useEffect(()=>{let s=document.querySelector(".message-container");const f=s.scrollHeight;s.scrollTop+=f-me.current,s.scroll},[P]),K("messages:newMessage",s=>{a.id===s.id&&(A.airplaneMode||N(f=>[...f,{...s,timestamp:Date.now()}]))}),K("messages:renameGroup",s=>{a.id===s.channelId&&(A.airplaneMode||r(f=>({...f,name:s.name})))}),K("messages:messageDeleted",s=>{s&&(A.airplaneMode||N(P.filter(f=>f.id!==s)))}),K("messages:removeMember",s=>{a.id===s.channelId&&(A.airplaneMode||s.number===i&&(u("userlist"),r(null)))});const Oe=De(s=>{let f=s.target;for(;!f.classList.contains("message");)f=f.parentElement;let C=f.getAttribute("data-id");if(!C)return;let U=P.find(B=>B.id===C);U&&U.sender===i&&(Se(U.content)||Ge(U.content)||fe(U.content)||Y.ContextMenu.set({buttons:[{title:l("APPS.MESSAGES.DELETE"),color:"red",cb:()=>{L("Messages",{action:"deleteMessage",id:C}).then(B=>{})}}]}))}),Ge=s=>!s||!j.EnableMessagePay?!1:/<!SENT-PAYMENT-(\d*)!>/.test(s)?!0:!!/<!REQUESTED-PAYMENT-(\d*)!>/.test(s),Se=s=>{if(s)return/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(s)},fe=s=>{if(s)return s==="<!CALL-NO-ANSWER!>"},Ue=s=>{if(s)return/<!AUDIO-MESSAGE-IMAGE="(.*)"-AUDIO="(.*)"-DURATION="(.*)"!>/.test(s)};return e(se,{children:m("div",{className:"animation-slide left",children:[m(oe,{children:[I&&e(rt,{setShow:k,setShowUserInfo:T,sendLocation:he,setData:r,data:a}),E&&e(nt,{setShow:T,user:a!=null&&a.isGroup?E:a})]}),m("div",{className:"message-header",children:[m("div",{className:"back",onClick:()=>{u("userlist"),r(null),a.unread&&(L("Messages",{action:"markRead",id:a.id}),o(s=>s-1))},children:[e(Le,{}),M>0&&e("span",{className:"back-title",children:M})]}),m("div",{className:"user",onClick:()=>{a.isGroup?k(!0):T(!0)},children:[a.isGroup?e("div",{className:"group-avatar",children:a.members.sort((s,f)=>s.avatar?1:-1).map((s,f)=>e("img",{src:s.avatar??"./assets/img/no-pfp.png",alt:""},f)).slice(0,5)}):e("img",{src:a.avatar??"./assets/img/no-pfp.png",className:"avatar"}),e("div",{className:"name",children:a.isGroup?a.name??`${a.members.length} ${l("APPS.MESSAGES.PEOPLE")}`:a.name??V(a.number)})]}),e(ke,{className:`facetime ${a.isGroup?"hidden":""}`,onClick:()=>{a.isGroup||Re({number:a.number,videoCall:!0})}})]}),e("div",{className:"message-container",onScroll:we,style:D||G?{height:"48%"}:{},children:e("div",{className:"message-body",children:P.map((s,f)=>e(et,{index:f,messages:P,message:s,longPressEvent:Oe,func:{isMissed:fe,isLocation:Se,isVoiceMessage:Ue,pay:ue}}))})}),e("div",{className:"attachments",children:$.attachments.map((s,f)=>m("div",{className:"attachment",children:[Me(s)?e("video",{src:s,muted:!0,controls:!1,loop:!0,autoPlay:!0}):e("img",{src:s}),e(ce,{onClick:()=>{ee({...$,attachments:$.attachments.filter((C,U)=>U!==f)})}})]},f))}),m("div",{className:"message-bottom",style:D||G?{height:"18%"}:{},children:[e("div",{className:"upper",children:m("div",{className:"input","data-border":!F,children:[F?m("div",{className:"audio-message",children:[e(ce,{onClick:()=>ae(null)}),e("div",{className:"audio-waves",children:e("img",{src:F.waves.placeholder})})]}):e(te,{placeholder:l("APPS.MESSAGES.PLACEHOLDER"),ref:ie,value:$.content,onChange:s=>{ee({content:s.target.value,attachments:$.attachments})},onKeyDown:s=>{s.key=="Enter"&&de()}}),($.content.length>0||$.attachments.length>0||F)&&e("div",{className:"send",onClick:()=>de(),children:e(pe,{})})]})}),e("div",{className:"actions-wrapper",children:m("div",{className:"actions",children:[e("div",{className:"action",onClick:()=>{if(p)return Y.Emoji.reset();Y.Emoji.set({onSelect:s=>ee(f=>({content:`${f.content}${s.emoji}`,attachments:f.attachments}))})},children:e("img",{src:"./assets/img/icons/messages/emoji.png"})}),e("div",{className:"action",onClick:()=>{var s,f,C;$.attachments.length<3&&Y.Gallery.set({includeVideos:!0,allowExternal:(C=(f=(s=J)==null?void 0:s.value)==null?void 0:f.AllowExternal)==null?void 0:C.Messages,onSelect:U=>ee({...$,attachments:[...$.attachments,U.src]})})},children:e("img",{src:"./assets/img/icons/messages/gallery.png"})}),(j==null?void 0:j.EnableMessagePay)&&!a.isGroup&&e("div",{className:"action black",onClick:()=>{y(!1),R(s=>!s)},children:"$"}),e("div",{className:"action",onClick:()=>he(),children:e(_e,{})}),(j==null?void 0:j.EnableVoiceMessages)&&e("div",{className:"action blue",onClick:()=>{R(!1),y(s=>!s)},children:e(be,{})})]})}),D&&e(st,{paymentAmount:O,setPaymentAmount:b,pay:ue,request:Te}),G&&e(tt,{onEnd:s=>{s&&(ae({src:URL.createObjectURL(s.blob),blob:s.blob,waves:s.waveform,duration:s.duration}),y(!1))}})]})]})})}const et=({messages:t,message:n,index:h,longPressEvent:A,func:i})=>{var D,R;const{User:a}=d.useContext(Z),r=_(x.PhoneNumber),[c]=a,u=_(J);let M,o,p,I,k,E,T=h===0?"last":"",G=n.sender===r?"self":"other",y=((D=t[h+1])==null?void 0:D.sender)===r?"self":"other";if(t[h+1]?p=Math.abs(n.timestamp-t[h+1].timestamp)/36e5:y=void 0,c.isGroup)M=(R=c.members.find(O=>O.number===n.sender))==null?void 0:R.name,o=!t[h-1]||t[h-1].sender!==n.sender;else if(n.content)if(i.isMissed(n.content))if(G==="other")n.content=l("APPS.MESSAGES.MISSED_CALL").format({number:n.sender});else return null;else/<!SENT-PAYMENT-(\d*)!>/.test(n.content)?I={amount:n.content.match(/\d/g).join(""),request:!1}:/<!REQUESTED-PAYMENT-(\d*)!>/.test(n.content)&&(I={amount:n.content.match(/\d/g).join(""),request:!0});if(i.isLocation(n.content)){let O=n.content.match(/X=(-?\d*\.?\d*)Y/)[1],b=n.content.match(/Y=(-?\d*\.?\d*)!>/)[1];k={x:O,y:b}}return i.isVoiceMessage(n.content)&&(E={wave:n.content.match(/AUDIO-MESSAGE-IMAGE="([^"]+)"/)[1],src:n.content.match(/AUDIO="([^"]+)"/)[1],duration:n.content.match(/DURATION="([^"]+)"/)[1]}),m("div",{className:`message ${G}`,id:T,"data-id":n.id,...A,children:[o&&G=="other"&&e("div",{className:"user",children:M??V(n.sender)}),n.delivered===!1?m("div",{className:"content-wrapper",children:[I&&e("div",{className:"payment",children:u.CurrencyFormat.replace("%s",I.amount)}),e("div",{className:"content",children:ge(n.content)}),e(Ve,{})]}):I||k||E?m(se,{children:[k&&m("div",{className:"location",onClick:()=>{x.App.set({name:"Maps",data:{location:[k.y,k.x],name:`${M??V(n.sender)}'s location`,icon:c.avatar}})},children:[e("div",{className:"img",style:{backgroundImage:'url("https://img.gta5-mods.com/q95/images/mirror-park-garden/2b72f9-20160428154103_1.jpg")'}}),G==="other"&&m("div",{className:"sender",children:[M??V(n.sender)," ",l("APPS.MESSAGES.SENT_LOCATION")]})]}),I&&e("div",{className:"payment",children:I.request?m("div",{className:`request ${G}`,children:[m("div",{className:"title",children:[u.CurrencyFormat.replace("%s",ve(I.amount)),l("APPS.MESSAGES.PAY.REQUESTED")]}),G==="other"&&e("div",{className:"button",onClick:()=>i.pay(I.amount),children:l("APPS.MESSAGES.PAY.PAY")})]}):e("div",{className:"sent",children:u.CurrencyFormat.replace("%s",ve(I.amount))})}),E&&e(at,{data:E,sender:G})]}):n.content&&e("div",{className:"content",children:ge(n.content)}),n.attachments&&n.attachments.length>0&&e("div",{className:"attatchments",children:n.attachments.map((O,b)=>Me(O)?e("video",{src:O,controls:!1,loop:!0,autoPlay:!0,muted:!0,onClick:H=>{Y.FullscreenImage.set({display:!0,image:O})}},b):e(Ye,{src:O,onClick:()=>{Y.FullscreenImage.set({display:!0,image:O})}},b))}),n.delivered===!1?e("div",{className:"status",children:l("APPS.MESSAGES.NOT_DELIVERED")}):t[h+1]&&p>6?e("div",{className:"date",children:Pe(n.timestamp)}):G!==y&&e("div",{className:"date",children:Pe(n.timestamp)})]},h)},tt=({onEnd:t})=>{const n=_(J),[h,A]=d.useState(!1),i=d.useRef(null);return n.EnableVoiceMessages?(d.useEffect(()=>{i.current=new Je},[]),K("camera:toggleMicrophone",a=>{i!=null&&i.current&&(a?i.current.unmute():i.current.mute())}),e("div",{className:"audioMessage-container",children:e("div",{className:"audioMessage-button","data-recording":h,onClick:()=>{var r;if(!((r=navigator.mediaDevices)!=null&&r.getUserMedia)||!(i!=null&&i.current))return W("error","No media devices found!");let a=i.current;h?a.stop().then(c=>{t(c),A(u=>!u)}):navigator.mediaDevices.getUserMedia({audio:!0}).then(c=>{a.start(c),A(u=>!u)})},children:h?e(ce,{}):e(be,{})})})):null},st=({paymentAmount:t,setPaymentAmount:n,request:h,pay:A})=>{const i=_(J),[a,r]=d.useState(0),[c,u]=d.useState(4);let M={0:3,11:2.75,14:2.2};return d.useEffect(()=>{a===0&&u(M[0]);let o=0;for(let p=0;p<Object.keys(M).length;p++)a>=parseInt(Object.keys(M)[p])&&(o=M[Object.keys(M)[p]]);u(o)},[a]),d.useEffect(()=>{n(a)},[a]),m("div",{className:"payment-container",children:[m("div",{className:"payment-wrapper",children:[e("div",{className:"button",onClick:()=>t>0&&r(o=>o-1),children:"-"}),e("div",{className:"amount",children:e(te,{type:"number",value:t,style:{fontSize:`${c}rem`},onChange:o=>{if(o.target.value.match(/^[0-9]+$/)&&parseFloat(o.target.value)>0&&parseFloat(o.target.value)<(i.MaxTransferAmount??Number.MAX_SAFE_INTEGER))r(parseFloat(o.target.value));else return o.preventDefault()}})}),e("div",{className:"button",onClick:()=>r(o=>o+1),children:"+"})]}),m("div",{className:"payment-buttons",children:[e("div",{className:"button",onClick:()=>h(t),children:l("APPS.MESSAGES.PAY.REQUEST")}),e("div",{className:"button",onClick:()=>A(t),children:l("APPS.MESSAGES.PAY.SEND")})]})]})},at=({data:t,sender:n})=>{var u;const[h,A]=d.useState(!1),[i,a]=d.useState(0),r=d.useRef(null);d.useEffect(()=>{r.current&&(r.current.onended=()=>{A(!1)})},[r]);const c=M=>{M=Math.floor(M);const o=Math.floor(M/60),p=M-o*60;return`${o<10?"0"+o:o}:${p<10?"0"+p:p}`};return m("div",{className:`voice-message ${n}`,children:[e("a",{onClick:()=>{r.current&&(h?(r.current.pause(),r.current.currentTime=0):r.current.play(),A(M=>!M))},children:h?e(Fe,{}):e(je,{})}),m("div",{className:"wave",children:[e("div",{className:"overlay",style:{width:`${(t.duration-i)/t.duration*100}%`}}),e("img",{src:t.wave,alt:"wave"})]}),e("div",{className:"duration",children:c(h&&Math.floor(((u=r.current)==null?void 0:u.currentTime)+.5)!==0?r.current.currentTime:t.duration)}),e("audio",{ref:r,onTimeUpdate:M=>a(M.currentTarget.currentTime),children:e("source",{src:t.src,type:"audio/mpeg"})})]})},nt=({user:t,setShow:n})=>m(ne.div,{...re,className:"info-panel",children:[e("div",{className:"info-panel-header",children:e("div",{className:"done",onClick:()=>n(!1),children:l("APPS.MESSAGES.DONE")})}),m("div",{className:"info-panel-body",children:[m("div",{className:"info-panel-top",children:[t.avatar?e("div",{className:"profile-image bigger",style:{backgroundImage:`url(${t.avatar})`}}):t.name?e("div",{className:"profile-image bigger",children:He(t.name)}):e("img",{src:t.avatar??"./assets/img/no-pfp.png",className:"avatar"}),e("div",{className:"name",children:t.name??V(t.number)})]}),e("div",{className:"items",children:!t.company&&m(se,{children:[t.name&&e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>xe(t.number),children:V(t.number)})}),e("div",{className:"info-section",children:t.name?e("div",{className:"item blue",onClick:()=>{Y.Share.set({type:"contact",data:{firstname:t.firstname,lastname:t.lastname,number:t.number,avatar:t.avatar}})},children:l("APPS.PHONE.CONTACTS.SHARE_CONTACT")}):e("div",{className:"item blue",onClick:()=>{x.App.set({name:"Phone",view:"newContact",data:t.number})},children:l("APPS.PHONE.CONTACTS.ADD_CONTACT")})})]})})]})]}),rt=t=>{const{View:n}=d.useContext(Z),[h,A]=n,[i,a]=d.useState(!1),[r,c]=d.useState(null);let u=t.data,M=!u.members.find(o=>o.isOwner);return m(se,{children:[e(oe,{children:i&&e(it,{setShow:a,members:u.members,id:u.id})}),m(ne.div,{...re,className:"info-panel",children:[e("div",{className:"info-panel-header",children:e("div",{className:"done",onClick:()=>{r&&r!==""&&r!==u.name?L("Messages",{action:"renameGroup",id:u.id,name:r}).then(o=>{t.setShow(!1)}):t.setShow(!1)},children:l("APPS.MESSAGES.DONE")})}),m("div",{className:"info-panel-body",children:[m("div",{className:"info-panel-top",children:[e("div",{className:"group-avatar",children:u.members.sort((o,p)=>o.avatar?1:-1).slice(0,10).map((o,p)=>e("img",{src:o.avatar??"./assets/img/no-pfp.png",alt:""},p))}),m("div",{className:"members",children:[u.members.length," ",l("APPS.MESSAGES.MEMBERS")]})]}),m("div",{className:"items",children:[e("div",{className:"info-section",children:m("div",{className:"item blue",children:[e(Xe,{className:"add"}),e(te,{defaultValue:u.name??"Group Name",onChange:o=>c(o.target.value)})]})}),m("div",{className:"info-section",children:[u.members.sort((o,p)=>o.name&&!p.name?-1:!o.name&&p.name?1:o.name<p.name?-1:o.name>p.name?1:0).map((o,p)=>m("div",{className:"item",children:[M&&e(qe,{className:"remove",onClick:()=>{Y.PopUp.set({title:l("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:l("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({name:o.name??V(o.number)}),buttons:[{title:l("APPS.MESSAGES.CANCEL")},{title:l("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{L("Messages",{action:"removeMember",number:o.number,id:u.id}).then(I=>{I&&(t.setData(k=>{let E=k;return E.members=E.members.filter(T=>T.number!==o.number),E}),t.setShow(!1))})}}]})}}),e("img",{src:o.avatar??"./assets/img/no-pfp.png",alt:""}),e("div",{className:"name",children:o.name??V(o.number)}),e(Be,{className:"info",onClick:()=>{t.setShowUserInfo({...o})}})]},p)),m("div",{className:"item blue",onClick:()=>a(!0),children:[e(Qe,{className:"add"}),l("APPS.MESSAGES.ADD_MEMBER")]})]}),e("div",{className:"info-section",children:e("div",{className:"item blue",onClick:()=>t.sendLocation(),children:l("APPS.MESSAGES.SHARE_LOCATION")})}),e("div",{className:"info-section",onClick:()=>{Y.PopUp.set({title:l("APPS.MESSAGES.LEAVE_POPUP.TITLE"),description:l("APPS.MESSAGES.LEAVE_POPUP.TEXT"),buttons:[{title:l("APPS.MESSAGES.CANCEL")},{title:l("APPS.MESSAGES.LEAVE_POPUP.LEAVE"),color:"red",cb:()=>{L("Messages",{action:"leaveGroup",id:u.id}).then(o=>{if(!o)return W("info","Failed to leave group, server didnt callback request");A("userlist"),t.setShow(!1)})}}]})},children:e("div",{className:"item red",children:l("APPS.MESSAGES.LEAVE_GROUP")})})]})]})]})]})},it=t=>{const n=_(x.PhoneNumber),[h,A]=d.useState(""),i=_(q.APPS.PHONE.contacts);let a=t.members;return m(ne.div,{...re,className:"add-member-container",children:[m("div",{className:"add-member-header",children:[m("div",{className:"top",children:[e("span",{}),e("div",{className:"title",children:l("APPS.MESSAGES.ADD_MEMBER")}),e("div",{className:"button",onClick:()=>t.setShow(!1),children:l("APPS.MESSAGES.CANCEL")})]}),e(Ce,{placeholder:l("APPS.MESSAGES.SEARCH"),onChange:r=>A(r.target.value)})]}),e("div",{className:"contacts",children:i.filter(r=>!r.company).sort((r,c)=>r.firstname&&!c.firstname?-1:!r.firstname&&c.firstname?1:r.firstname<c.firstname?-1:r.firstname>c.firstname?1:0).filter(r=>!a.find(c=>c.number===r.number)||r.number===n).filter(r=>{var c,u;return r.firstname.toLowerCase().includes(h.toLowerCase())||((u=(c=r==null?void 0:r.lastname)==null?void 0:c.toLowerCase())==null?void 0:u.includes(h.toLowerCase()))}).map((r,c)=>{let u=Q(r.firstname,r.lastname);return m("div",{className:"contact",onClick:()=>{Y.PopUp.set({title:l("APPS.MESSAGES.ADD_POPUP.TITLE"),description:l("APPS.MESSAGES.ADD_POPUP.TEXT").format({name:u}),buttons:[{title:l("APPS.MESSAGES.CANCEL")},{title:l("APPS.MESSAGES.ADD_POPUP.ADD"),cb:()=>{L("Messages",{action:"addMember",number:r.number,id:t.id}).then(M=>{M&&t.setShow(!1)})}}]})},children:[e("img",{src:r.avatar??"./assets/img/no-pfp.png"}),m("div",{className:"user",children:[e("div",{className:"name",children:u}),e("div",{className:"number",children:V(r.number)})]})]},c)})})]})};function lt(){const{User:t,View:n,Newmessage:h,ImportedUser:A}=d.useContext(Z),[i,a]=t,[r,c]=n,[u,M]=A,o=_(x.PhoneNumber),[p,I]=h,k=_(q.APPS.PHONE.contacts),[E,T]=d.useState([]),G=d.useRef(null),[y,D]=d.useState(""),[R,O]=d.useState([]),[b,H]=d.useState({content:"",attachments:[]});d.useEffect(()=>{u&&(T([u]),M(null))},[u]);const X=()=>{(b.content.length>0||b.attachments.length>0)&&(E.length>1?L("Messages",{action:"createGroup",members:E,content:b.content,attachments:b.attachments}).then(g=>{g&&(a({isGroup:!0,members:E.map(S=>{let v=Q(S.firstname,S.lastname);return{...S,name:v}}),lastMessage:b.content,timestamp:Date.now(),id:g}),c("messages"),I(!1))}):L("Messages",{action:"sendMessage",number:E[0].number,content:b.content,attachments:b.attachments}).then(g=>{var S,v,w,P;if(g){let N;E[0].name?N=E[0].name:(S=E[0])!=null&&S.firstname&&(N=Q((v=E[0])==null?void 0:v.firstname,(w=E[0])==null?void 0:w.lastname));let F={number:E[0].number,name:N,avatar:(P=E[0])==null?void 0:P.avatar};a({...F,lastMessage:b.content,timestamp:Date.now(),id:g}),c("messages"),I(!1)}}))};return d.useEffect(()=>{if(y.length>0){if(k){const g=k.filter(S=>{let v=Q(S.firstname,S.lastname);return v&&v.toLowerCase().includes(y.toLowerCase())&&!S.company});O(g)}}else O([])},[y]),m(ne.div,{...re,className:"new-message-container",children:[m("div",{className:"new-message-header",children:[e("span",{}),e("div",{className:"title",children:l("APPS.MESSAGES.NEW_MESSAGE")}),e("div",{className:"button",onClick:()=>{E.length>0&&(b.content.length>0||b.attachments.length>0)?X():I(!1)},children:E.length>0&&(b.content.length>0||b.attachments.length>0)?l("APPS.MESSAGES.SEND"):l("APPS.MESSAGES.CANCEL")})]}),m("div",{className:"new-message-body",children:[m("div",{className:"new-message-search",children:[m("div",{className:"to",children:[l("APPS.MESSAGES.TO"),":"]}),e("div",{className:"contacts",children:E.map((g,S)=>{let v=Q(g.firstname,g.lastname),w=v!=="Unknown";return e("div",{className:`contact ${w?"green":"blue"}`,onClick:()=>{Y.PopUp.set({title:l("APPS.MESSAGES.REMOVE_POPUP.TITLE"),description:l("APPS.MESSAGES.REMOVE_POPUP.TEXT").format({NAME:v??V(g.number)}),buttons:[{title:l("APPS.MESSAGES.CANCEL")},{title:l("APPS.MESSAGES.REMOVE_POPUP.REMOVE"),color:"red",cb:()=>{let P=E.filter(N=>N.number!==g.number);T(P)}}]})},children:w?v:V(g.number)},S)})}),e(te,{type:"text",ref:G,onChange:g=>{if(D(g.target.value),g.target.value.length==o.length&&/^\d+$/g.test(g.target.value)){if(g.target.value===o||E.find(v=>v.number==g.target.value))return;T([...E,{number:g.target.value}]),G.current.value="",D("")}},onKeyDown:g=>{var S;g.key=="Backspace"&&y.length==0?((S=E[E.length-1])==null?void 0:S.name)===void 0?(G.current.value=E[E.length-1].number,T(E.slice(0,E.length-1))):T(E.slice(0,-1)):g.key=="Tab"&&(g.preventDefault(),R.length==1&&(T([...E,R[0]]),G.current.value="",D("")))}})]}),e("div",{className:"search-results",children:R&&R.filter(g=>!E.find(S=>S.number==g.number)).map((g,S)=>{let v=Q(g.firstname,g.lastname);return m("div",{className:"contact",onClick:()=>{E.find(P=>P.number==g.number)||(T([...E,g]),G.current.value="",D(""))},children:[e("img",{src:g.avatar??"./assets/img/no-pfp.png"}),m("div",{className:"user",children:[e("div",{className:"name",children:v}),e("div",{className:"number",children:V(g.number)})]})]},S)})})]}),E.length>0&&R.length===0&&e("div",{className:"message-bottom absolute",children:e("div",{className:"upper",children:m("div",{className:"input",children:[e(te,{placeholder:l("APPS.MESSAGES.PLACEHOLDER"),value:b.content,onChange:g=>{H({content:g.target.value??"",attachments:b.attachments})},onKeyDown:g=>{g.key=="Enter"&&X()}}),(b.content.length>0||b.attachments.length>0)&&e("div",{className:"send",onClick:()=>X(),children:e(pe,{})})]})})})]})}function ct(){const{User:t,View:n,Newmessage:h,UnreadMessages:A,ImportedUser:i}=d.useContext(Z),a=_(x.PhoneNumber),r=_(x.Settings),c=_(x.App),[u,M]=t,[o,p]=n,[I,k]=i,[E,T]=h,[G,y]=A,D=_(q.APPS.PHONE.contacts),R=_(q.APPS.MESSAGES.messages),[O,b]=d.useState(""),[H,X]=d.useState([]);d.useEffect(()=>{R?(W("info","Using cache for recent messages"),X(R),y(H.filter(S=>S.unread).length)):L("Messages",{action:"getRecentMessages"}).then(S=>{let v=S.map(w=>{if(w.isGroup)return w.members=w.members.filter(P=>P.number!==a).map(P=>{let N=D.find(F=>F.number===P.number);return{name:N&&N.firstname?Q(N==null?void 0:N.firstname,N==null?void 0:N.lastname):void 0,avatar:N==null?void 0:N.avatar,blocked:N==null?void 0:N.blocked,favourite:N==null?void 0:N.favourite,number:P.number,isOwner:P.isOwner}}),w;{let P=D.find(N=>N.number===w.number);return w.name=P!=null&&P.lastname?`${P.firstname} ${P.lastname}`:P==null?void 0:P.firstname,w.avatar=P==null?void 0:P.avatar,w}});y(v.filter(w=>w.unread).length),X(v),W("info","setting cache"),q.APPS.MESSAGES.messages.set(v)})},[R]);let g=d.useRef(!1);return d.useEffect(()=>{if(!g.current&&c!=null&&c.data&&(g.current=!0,c!=null&&c.data&&c.view=="messages")){let S=H.find(v=>v.number===c.data.number);S?(M(S),p("messages")):(T(!0),k({number:c.data.number,name:c.data.name,avatar:c.data.avatar})),x.App.set({name:c.name})}},[c==null?void 0:c.data,H]),K("messages:newMessage",S=>{let v=JSON.parse(JSON.stringify(H)),w=v.findIndex(P=>P.id===S.id);r.airplaneMode||(w!==-1&&v.unshift(v.splice(w,1)[0]),v[0].lastMessage=S.content,v[0].timestamp=new Date,X(v))}),m(se,{children:[e(oe,{children:E&&e(lt,{})}),m("div",{className:`animation-slide ${H.length>0?"right":""}`,children:[m("div",{className:"messages-header",children:[e("div",{className:"title",children:l("APPS.MESSAGES.TITLE")}),e(We,{onClick:()=>T(!0)})]}),e(Ce,{placeholder:l("SEARCH"),onChange:S=>b(S.target.value)}),e("div",{className:"users-list",children:H.filter(S=>{var v;return(S.isGroup?S.members.find(w=>{var P;return((P=w.name)==null?void 0:P.toLowerCase().includes(O.toLowerCase()))||w.number.includes(O)}):((v=S.name)==null?void 0:v.toLowerCase().includes(O.toLowerCase()))||S.number.includes(O))||S.lastMessage.toLowerCase().includes(O.toLowerCase())}).sort((S,v)=>v.timestamp-S.timestamp).map((S,v)=>e(ot,{user:S,onClick:()=>{if(M(S),p("messages"),S.unread){L("Messages",{action:"markRead",id:S.id}),y(P=>P-1);let w=q.APPS.MESSAGES.messages.value;q.APPS.MESSAGES.messages.set(w.map(P=>(P.id===S.id&&(P.unread=!1),P)))}}},v))})]})]})}const ot=({user:t,onClick:n})=>{const h=_(J);let A;if(t.isGroup?t.name?A=t.name:A=t.members.sort((i,a)=>i.name&&!a.name?-1:!i.name&&a.name?1:i.name<a.name?-1:i.name>a.name?1:0).map((i,a)=>{if(a<2)return i.name?i.name:V(i.number);if(a===2)return`+${t.members.length-2} ${l("APPS.MESSAGES.OTHER").toLowerCase()}`}).join(" "):A=t.name,t.lastMessage==="Attachment"&&(t.lastMessage=l("APPS.MESSAGES.SENT_A_PHOTO")),/<!SENT-PAYMENT-(\d*)!>/.test(t.lastMessage)){let i=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${l("APPS.MESSAGES.SENT")} ${h.CurrencyFormat.replace("%s",i)}`}else if(/<!REQUESTED-PAYMENT-(\d*)!>/.test(t.lastMessage)){let i=t.lastMessage.match(/\d/g).join("");t.lastMessage=`${l("APPS.MESSAGES.REQUESTED")} $${i}`}else if(/<!SENT-LOCATION-X=(-?\d*\.?\d*)Y=(-?\d*\.?\d*)!>/.test(t.lastMessage))t.lastMessage=`${l("APPS.MESSAGES.SENT_LOCATION_SHORT")}`;else if(t.lastMessage.startsWith('<!AUDIO-MESSAGE-IMAGE="'))t.lastMessage="sent an audio message";else if(t.lastMessage==="<!CALL-NO-ANSWER!>")t.lastMessage=`${V(t.number)} tried to call you`;else if(t.lastMessage==="")return;return m("div",{className:"user",onClick:()=>n(),children:[e("div",{className:`read${t.unread?" unread":""}`}),t.isGroup?e("div",{className:"avatar group",children:t.members.map((i,a)=>{if(a<=4)return i.avatar?e("div",{style:{backgroundImage:`url(${i.avatar})`}},a):i.name?e("div",{children:i.name.charAt(0)},a):e("div",{className:"unknown"},a)})}):e("img",{className:"avatar",src:t.avatar??"assets/img/no-pfp.png"}),m("div",{className:"user-body",children:[m("div",{className:"user-header",children:[e("div",{className:"name",children:A??V(t.number)}),m("div",{className:"right",children:[e("div",{className:"time",children:ze(t.timestamp)}),e(Ke,{})]})]}),e("div",{className:"content",children:t.lastMessage.length>40?t.lastMessage.substring(0,40)+"...":t.lastMessage})]})]})};const Z=d.createContext(null);function St(){const[t,n]=d.useState(null),[h,A]=d.useState("userlist"),[i,a]=d.useState(null),[r,c]=d.useState(0),[u,M]=d.useState(!1);return e("div",{className:"messages-container",children:e(Z.Provider,{value:{User:[t,n],View:[h,A],Newmessage:[u,M],ImportedUser:[i,a],UnreadMessages:[r,c]},children:h=="userlist"?e(ct,{}):e(Ze,{})})})}export{Z as MessagesContext,St as default};
